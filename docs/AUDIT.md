## RekTrace → RugScanner: Plan-Parity Audit

This document tracks the parity between the Plan Canon and the current repository state. It begins with a quick index of what exists vs what is missing, followed by a gap-analysis matrix to drive fixes.

### Quick Index Summary
- Present docs: `PRELAUNCH.md`, `README_PRELAUNCH.md`, `rektrace-rugscan/README.md`
- Missing docs: `OPERATIONS.md`, `API.md`, `CONFIG.md`, `SECURITY.md`, `TELEGRAM.md`, `CHANGELOG.md`, `CONTRIBUTING.md`, `.github/ISSUE_TEMPLATE/bug_report.md`, `pull_request_template.md`, `docs/architecture.mmd`, `docs/flow_alerts.mmd`
- Entrypoints: `rektrace-rugscan/src/index.ts` (Telegram + HTTP), `src/index.ts` (holders bot)
- Core modules: `rektrace-rugscan/src/{commands.ts,scan.ts,enrich.ts,lp_lock.ts,alerts_sub.ts,alerts/*,rate_limit.ts,cbmap.ts,url.ts,track_recent.ts,status_util.ts,wallet_trace.ts}`
- Tests: 26 Vitest specs under `rektrace-rugscan/tests/**` (no skipped tests found); scripts: `scripts/{smoke.sh,hammer.sh,canary.sh}`
- TODO/FIXME/NOTE: no explicit TODO/FIXME found in `rektrace-rugscan/src/**` or `rektrace-rugscan/tests/**`

### Plan vs Implementation Matrix

| Area | Expected (Plan Canon) | Found (files/symbols) | Evidence (lines) | Risk | Fix |
|---|---|---|---|---|---|
| Commands & UX | `/scan`, inline scans (ambiguity + pagination 6/page), `/scan_plus`, `/trace`, `/recent_rugs`, `/status`, `/my_alerts` | `rektrace-rugscan/src/commands.ts`, `rektrace-rugscan/src/index.ts` | `commands.ts:L14-L47` scan + buttons; `commands.ts:L80-L104,L178-L201` inline + pagination; `commands.ts:L59-L77` scan_plus; `index.ts:L31-L52` trace; `index.ts:L54-L64` recent_rugs; `index.ts:L137-L141` status; `commands.ts:L49-L56` my_alerts | Docs gaps on UX (callback expiry copy, MD escaping examples) | Add `TELEGRAM.md` with flows, pagination (6/page), expiry UX, Markdown rules |
| Scan pipeline | EVM (GoPlus + Covalent holders), Solana (RugCheck + Solscan holders), DexScreener liquidity/price; flags, scoring 0..100 with LP lock/burn/unlockDays + locker | `rektrace-rugscan/src/scan.ts`, `rektrace-rugscan/src/lp_lock.ts`, `src/providers.ts` | `scan.ts:L273-L283,L284-L297,L299-L317,L321-L333`; `lp_lock.ts:L1-L31`; `providers.ts:L116-L201` | Provider coverage depends on keys; LP lock/burn best‑effort from DexScreener | Document provider key requirements, best‑effort semantics in `API.md`; note risk‑signals language |
| Enrichment | Price snapshot, deployer + creation date (Covalent), cache TTLs | `rektrace-rugscan/src/enrich.ts` | `enrich.ts:L38-L63` price; `enrich.ts:L65-L95` Covalent meta; `enrich.ts:L15-L22,L97-L123` cache TTLs | Covalent key missing → meta omitted silently | `CONFIG.md` required keys; `API.md` clarify optional enrichment fields |
| LP lock & flags | Parser, lock/burn/unlockDays + locker attribution | `rektrace-rugscan/src/lp_lock.ts` used by `scan.ts` | `lp_lock.ts:L3-L31`; usage `scan.ts:L299-L316` | Variability across DEX pairs; locker mapping heuristic | Document heuristics in `API.md` and `SECURITY.md` risk‑signals framing |
| Subscriptions & background checker | “Alert me” + checker (score drop ≥ ALERT_SCORE_DROP, LP unlock <7d), Redis-backed | `alerts_sub.ts`, `alerts/checker.ts`, `alerts/dm_cap.ts`, `alerts/throttler.ts`, wiring in `index.ts` | `commands.ts:L160-L169` subscribe; `alerts_sub.ts:L21-L33,L35-L50,L52-L61,L63-L73,L75-L107,L109-L121`; `alerts/checker.ts:L6-L14,L16-L51`; `index.ts:L271-L278` background loop | Demo should not send DMs; Redis optional in-memory fallback | `SECURITY.md` demo wall; `OPERATIONS.md` alert noise runbook; `CONFIG.md` alert knobs |
| Safety rails | Demo wall, breakers + hysteresis + lastTransitionAt, timeouts/retries, cache TTLs, strict Markdown escaping, shortener denylist, callback mapper <64B (TTL 600s), per-user DM cap, global QPS | `index.ts`, `rektrace-rugscan/src/{rate_limit.ts,cbmap.ts,url.ts,status_util.ts}`, `src/{providers.ts,metrics.ts,health.ts}`, `commands.ts` | Demo wall: `scan.ts:L245-L248`, `enrich.ts:L103-L114`, `index.ts:L274`; Breakers/metrics: `providers.ts:L11-L21,L43-L63`, `metrics.ts:L46-L63`, status body: `status_util.ts:L4-L13`; Timeouts/retries: `providers.ts:L7-L10,L23-L41`; Shortener: `commands.ts:L17-L20`, `index.ts:L218-L219,L238-L239`; Callback map: `cbmap.ts:L3,L15-L26,L28-L41` (TTL=600s); DM cap: `alerts/dm_cap.ts:L11-L14`; Global QPS: `rate_limit.ts:L18-L26`; MD escaping: `commands.ts:L2,L11` | Missing doc for HMR-safe QPS, callback 64B rule; ensure `/metrics`/`/status` exempt from RL | `OPERATIONS.md` ops exemptions; `TELEGRAM.md` callback size + expiry; `API.md` rate-limit behavior |
| Observability | `/metrics` JSON (p50/p90/error%), `/status` budgets + breaker state (+alerts via `?verbose=1`) | `src/health.ts`, `rektrace-rugscan/src/index.ts`, `src/metrics.ts` | `/metrics`: `health.ts`; `/status`: `index.ts` (+alerts); p50/p90/error%: `metrics.ts` | No doc of field meanings; budgets not described centrally | `OPERATIONS.md` SLI table; `API.md` examples |
| Liveness/Readiness | `/live` and `/ready` endpoints for orchestration | `src/health.ts`, `rektrace-rugscan/src/index.ts` | `/live` returns 200; `/ready` returns 200/503 based on env and breakers | None | Documented in README_PRELAUNCH.md |
| Maintenance controls | Env-gated maintenance, breaker force-open, read-only | `rektrace-rugscan/src/index.ts` | 503 + Retry-After for non-exempt; deterministic stubs when forced | Defaults safe; docs added | See `docs/MAINTENANCE_AND_FREEZE.md` |
| Logs | JSON logs with request id; redaction list | `src/observability/request_id.ts` | Redacts substrings from `LOG_REDACT_LIST` | Works alongside pm2-logrotate; extra scrub script | Included in README and docs |
| API/Webhook | POST `/api/scan`, GET `/api/scan/:chain/:token?enrich=true` (optional API key) | `rektrace-rugscan/src/index.ts` | POST: `index.ts:L208-L227`; GET: `L230-L253`; API key gate: `L178-L181` | Need stable response schema docs; 429 copy | `API.md` schemas + curl; keep shape stable |
| Tests coverage | 30+ Vitest; throttler, holders consensus ±10% relative-to-max, QPS, denylist, cbmap TTL, DM cap resets | `rektrace-rugscan/tests/**` | Throttler `alerts_throttle.spec.ts`; Holders consensus `holders_fallback.spec.ts`; QPS `global_qps.spec.ts`; Denylist `denylist.spec.ts`; cbmap `cbmap.spec.ts`; DM cap `dm_cap.spec.ts`; pagination `pagination.spec.ts`; metrics/status `status_*` | Ensure all remain green post-docs | No code change; run `pnpm test:all` in CI |
| Demo vs Prod split | `DEMO_MODE=true` never hits live providers; respect budgets | `scan.ts`, `enrich.ts`, `index.ts`, `src/providers.ts` | `scan.ts:L245-L248`; `enrich.ts:L103-L114`; alerts loop guard `index.ts:L274`; provider budgets `providers.ts:L7-L10` | Accidental live calls in Demo could leak keys | `SECURITY.md` demo wall policy; `CONFIG.md` defaults |
| Rate limits / denylist / callback mapping | Global QPS, shortener block (HTTP+chat), callback <64B TTL=600s | `rate_limit.ts`, `url.ts`, `cbmap.ts`, `index.ts`, `commands.ts` | See Safety row evidence | Ambiguity on callback size in docs | `TELEGRAM.md` add explicit 64B note |
| Deployment / Runbooks / Config | Prelaunch, scripts, env docs | `scripts/*.sh`, `PRELAUNCH.md` | `scripts/smoke.sh`, `scripts/hammer.sh`, `scripts/canary.sh`; prelaunch doc exists | Missing CONFIG/OPS docs | Add `CONFIG.md`, `OPERATIONS.md` |
| Security & privacy language | Public data only, “risk signals” language, secrets in env | Code uses public APIs and `.env.*` | Providers use public on-chain/web; env via `dotenv` `index.ts:L1-L3` | Docs missing | Add `SECURITY.md` with privacy language and incident response |

Notes:
- Evidence line references will be filled while completing the audit in subsequent steps.
- “Risk” and “Fix” will be used to prioritize code/doc edits before launch.


